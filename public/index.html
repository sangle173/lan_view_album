<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LAN File Album</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Uppy -->
    <link href="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.css" rel="stylesheet">
    <script src="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.js"></script>

    <style>
        body {
            background-color: #f9f9f9;
        }
        .card img, .card video {
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .card {
            border: none;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            background: white;
        }
        .card-body {
            padding: 0.5rem;
        }
        .btn-sm {
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="p-3">

<h2 class="mb-4 text-center">üìÇ LAN File Album</h2>

<!-- Uppy Upload Area -->
<div id="drag-drop-area" class="mb-5"></div>

<!-- Gallery -->
<h4>üì∏ Uploaded Files</h4>
<div id="gallery" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-6 g-3 mt-2"></div>
<div id="upload-status" class="text-center mt-4" style="display: none;">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2">Waiting for iCloud image to download...</p>
</div>
<script>
    // Initialize Uppy
    const uppy = new Uppy.Uppy({ restrictions: { maxNumberOfFiles: 1000 } })
        .use(Uppy.Dashboard, {
            inline: true,
            target: '#drag-drop-area',
            showProgressDetails: true,
            proudlyDisplayPoweredByUppy: false,
            note: 'Images, Videos, Audios, Documents supported',
            height: 300
        })
        .use(Uppy.XHRUpload, {
            endpoint: '/upload',
            fieldName: 'file',
            bundle: false
        });

    // iCloud image handling: empty file size
    uppy.on('file-added', (file) => {
        if (file.size === 0) {
            alert(`‚ö†Ô∏è The file "${file.name}" appears to be empty. This can happen if the photo is still in iCloud.\n\nPlease wait for it to fully download in the Photos app before uploading.`);
        }
    });

    // iCloud: Show spinner if upload takes long to start
    let icloudTimeout = null;
    uppy.on('upload', () => {
        icloudTimeout = setTimeout(() => {
            document.getElementById('upload-status').style.display = 'block';
        }, 2000); // Show after 2s if upload is delayed (iCloud download time)
    });

    uppy.on('upload-success', () => {
        clearTimeout(icloudTimeout);
        document.getElementById('upload-status').style.display = 'none';
    });

    uppy.on('upload-error', (file, error, response) => {
        clearTimeout(icloudTimeout);
        document.getElementById('upload-status').style.display = 'none';

        const isIcloudEmpty = response?.body?.message?.includes('File is empty');
        if (isIcloudEmpty) {
            alert(`‚ö†Ô∏è "${file.name}" could not be uploaded.\nIt appears to still be in iCloud.\n\nPlease open it in the Photos app and wait until it fully downloads, then try again.`);
        } else {
            alert(`‚ùå Upload failed for "${file.name}": ${response?.body?.message || error}`);
        }
    });

    uppy.on('complete', () => {
        alert('‚úÖ Upload complete!');
        loadGallery();
    });

    // Load gallery
    function loadGallery() {
        fetch('/uploads')
            .then(res => res.json())
            .then(files => {
                const gallery = document.getElementById('gallery');
                gallery.innerHTML = '';
                files.reverse().forEach(file => {
                    const ext = file.split('.').pop().toLowerCase();
                    const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
                    const isVideo = ['mp4', 'webm', 'mov'].includes(ext);
                    const isAudio = ['mp3', 'wav', 'ogg'].includes(ext);
                    const thumb = isImage ? `/thumbnails/${file}` : '';
                    const url = `/uploads/${file}`;

                    let media = isImage
                        ? `<img src="${thumb}" class="card-img-top" loading="lazy">`
                        : isVideo
                            ? `<video controls width="100%" preload="metadata"><source src="${url}"></video>`
                            : isAudio
                                ? `<audio controls class="w-100 mt-2"><source src="${url}"></audio>`
                                : `<div class="card-body small text-muted">${file}</div>`;

                    gallery.insertAdjacentHTML('beforeend', `
                    <div class="col">
                        <div class="card h-100">
                            ${media}
                            <div class="d-flex justify-content-between p-2">
                                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file}')">üóëÔ∏è</button>
                                <button class="btn btn-sm btn-secondary" onclick="renameFilePrompt('${file}')">‚úèÔ∏è</button>
                            </div>
                        </div>
                    </div>`);
                });
            });
    }

    function deleteFile(file) {
        if (confirm('üóëÔ∏è Are you sure you want to delete this file?')) {
            fetch(`/delete/${file}`, { method: 'DELETE' })
                .then(() => loadGallery());
        }
    }

    function renameFilePrompt(oldName) {
        const newName = prompt('Enter new filename (with extension):', oldName);
        if (newName && newName !== oldName) {
            fetch('/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ oldName, newName })
            }).then(() => loadGallery());
        }
    }

    // Initial load
    loadGallery();
</script>


</body>
</html>
